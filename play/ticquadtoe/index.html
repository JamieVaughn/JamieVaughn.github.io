<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://unpkg.com/react@17/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./quadai.js"></script>
    <!-- <script type="module" src="index.mjs"></script>
    <script type="module" src="utils.mjs"></script> -->
    <link rel="stylesheet" href="tictactoe/style.module.css" />
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // board Map
      //  0 |1 |2 |3
      //  4 |5 |6 |7
      //  8 |9 |10|11
      //  12|13|14|15

      const Square = ({ onClick, value, isWinner }) => (
        <button className={`square ${isWinner ? 'winning' : ''}`} onClick={onClick}>
          {value}
        </button>
      );

      const Board = ({ onClick, squares, winner }) => {
        console.log('winner', winner)
        return (
          <div className="board">
            {squares.map((s, i) => (
              <Square key={i} value={s} isWinner={winner?.includes(i)} onClick={() => onClick(i)} />
            ))}
          </div>
        )
      };

      const Game = ({oneplayer}) => {
        const [history, setHistory] = React.useState([Array(16).fill(null)]);
        const [step, setStep] = React.useState(0);
        const [xIsNext, setXIsNext] = React.useState(true);
        const winner = calculateWinner(history[step]);

        if(!winner && oneplayer && !xIsNext) {
          const timeInHistory = history.slice(0, step + 1);
          const current = timeInHistory[step];
          const squares = [...current];
          let i = squares.reduce((acc, cur, index) => {
            console.log('i', acc, cur, index, 'step', step)
            if(cur === null) acc.push(index)
            return acc
          }, [])[Math.floor(Math.random() * (16 - step))]
          console.log('o', squares, i)
          if (winner?.winner || squares[i]) return;
          squares[i] = xIsNext ? "X" : "O";
          setHistory([...timeInHistory, squares]);
          setStep(timeInHistory.length);
          setXIsNext(!xIsNext);
        }
        
        const handleClick = (i) => {
          if(oneplayer && !xIsNext) return
          const timeInHistory = history.slice(0, step + 1);
          const current = timeInHistory[step];
          const squares = [...current];
          if (winner?.winner || squares[i]) return;
          squares[i] = xIsNext ? "X" : "O";
          setHistory([...timeInHistory, squares]);
          setStep(timeInHistory.length);
          setXIsNext(!xIsNext);
        };

        const jumpTo = (step) => {
          setStep(step);
          if (step === 0) setHistory([Array(16).fill(null)]);
          setXIsNext(step % 2 === 0);
        };

        const renderMoves = () => {
          return history.map((_step, move) => {
            const destination = move ? `Go to move #${move}` : "Reset";
            return (
              <li key={move} style={{ listStyle: "none" }}>
                <button onClick={() => jumpTo(move)}>{destination}</button>
              </li>
            );
          });
        };

        return (
          <>
            <Board onClick={handleClick} squares={history[step]} winner={winner?.squares}/>
            <div className="players">
              <p>
                {step <= 16 && winner?.winner
                  ? "Winner: " + winner?.winner
                  : step === 16 && !winner?.winner 
                      ? "Draw!" 
                      : "Next Player: " + (xIsNext ? "Xs" : "Os")}
              </p>
              {!!step && renderMoves()}
            </div>
          </>
        );
      };

      function TicTacToe() {
        const [oneplayer, setOneplayer] = React.useState(false)
        return (
          <>
            <h1 className='center'>Tic Quad Toe</h1>
            <h2 className='center'>Place <strong>FOUR</strong> pieces in a <strong>LINE</strong> or a <strong>BOX</strong> to win (2 Players).</h2>
            <label style={{display: 'flex', justifyContent: 'center'}}>
              Two Players
              <input style={{width: '30px'}} value={Number(oneplayer)} onClick={() => setOneplayer(!oneplayer)} type="range" min="0" max="1" />
              One Player
            </label>
            <Game oneplayer={oneplayer}/>
          </>
        )
      }

      ReactDOM.render(<TicTacToe />, document.getElementById("root"));
    </script>
  </body>
</html>
